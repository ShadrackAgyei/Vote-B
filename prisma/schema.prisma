// Vote-B Database Schema
// PostgreSQL via Supabase

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// SCHOOLS & ORGANIZATIONS
// ============================================================================

model School {
  id              String   @id @default(uuid())
  name            String   @db.VarChar(255)
  domain          String?  @unique @db.VarChar(100)
  allowedDomains  String[]
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  elections Election[]
  voters    Voter[]

  @@index([domain])
  @@map("schools")
}

// ============================================================================
// ELECTIONS
// ============================================================================

model Election {
  id          String    @id @default(uuid())
  schoolId    String?   @map("school_id")
  title       String    @db.VarChar(255)
  description String?   @db.Text
  startDate   DateTime  @map("start_date")
  endDate     DateTime  @map("end_date")
  isActive    Boolean   @default(false) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  school            School?             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  positions         Position[]
  voters            Voter[]
  voteRecords       VoteRecord[]
  verificationCodes VerificationCode[]

  @@index([schoolId])
  @@index([isActive])
  @@index([startDate, endDate])
  @@map("elections")
}

// ============================================================================
// POSITIONS & CANDIDATES
// ============================================================================

model Position {
  id           String   @id @default(uuid())
  electionId   String   @map("election_id")
  title        String   @db.VarChar(255)
  description  String?  @db.Text
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  election    Election     @relation(fields: [electionId], references: [id], onDelete: Cascade)
  candidates  Candidate[]
  voteRecords VoteRecord[]

  @@index([electionId])
  @@index([electionId, displayOrder])
  @@map("positions")
}

model Candidate {
  id          String   @id @default(uuid())
  positionId  String   @map("position_id")
  name        String   @db.VarChar(255)
  description String?  @db.Text
  pictureUrl  String?  @map("picture_url") @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  position    Position     @relation(fields: [positionId], references: [id], onDelete: Cascade)
  voteRecords VoteRecord[]

  @@index([positionId])
  @@map("candidates")
}

// ============================================================================
// VOTERS & VERIFICATION
// ============================================================================

model Voter {
  id         String    @id @default(uuid())
  email      String    @db.VarChar(255)
  electionId String    @map("election_id")
  schoolId   String?   @map("school_id")
  isVerified Boolean   @default(false) @map("is_verified")
  verifiedAt DateTime? @map("verified_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  // Relations
  election Election @relation(fields: [electionId], references: [id], onDelete: Cascade)
  school   School?  @relation(fields: [schoolId], references: [id], onDelete: SetNull)

  @@unique([email, electionId])
  @@index([schoolId])
  @@index([isVerified])
  @@map("voters")
}

model VerificationCode {
  id         String    @id @default(uuid())
  email      String    @db.VarChar(255)
  electionId String    @map("election_id")
  code       String    @db.VarChar(6)
  expiresAt  DateTime  @map("expires_at")
  used       Boolean   @default(false)
  usedAt     DateTime? @map("used_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  // Relations
  election Election @relation(fields: [electionId], references: [id], onDelete: Cascade)

  @@index([email, electionId])
  @@index([expiresAt])
  @@map("verification_codes")
}

// ============================================================================
// VOTE RECORDS (BLOCKCHAIN)
// ============================================================================

model VoteRecord {
  id          String   @id @default(uuid())
  voterEmail  String   @map("voter_email") @db.VarChar(255)
  electionId  String   @map("election_id")
  positionId  String   @map("position_id")
  candidateId String   @map("candidate_id")
  voteHash    String   @map("vote_hash") @db.VarChar(64)
  blockHash   String?  @map("block_hash") @db.VarChar(64)
  blockIndex  Int?     @map("block_index")
  timestamp   DateTime @default(now())
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  election  Election  @relation(fields: [electionId], references: [id], onDelete: Cascade)
  position  Position  @relation(fields: [positionId], references: [id], onDelete: Cascade)
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@unique([voterEmail, positionId])
  @@index([electionId])
  @@index([candidateId])
  @@index([blockHash])
  @@map("vote_records")
}

// ============================================================================
// BLOCKCHAIN BLOCKS (Optional - for full blockchain storage)
// ============================================================================

model BlockchainBlock {
  id           String   @id @default(uuid())
  electionId   String   @map("election_id")
  blockIndex   Int      @map("block_index")
  previousHash String   @map("previous_hash") @db.VarChar(64)
  hash         String   @unique @db.VarChar(64)
  nonce        Int
  timestamp    DateTime
  transactions Json     @db.JsonB
  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([electionId, blockIndex])
  @@index([hash])
  @@map("blockchain_blocks")
}
